<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecrew Absensi - Transwisata Prima Aviation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .map-container {
            height: 200px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .news-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .news-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .status-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl p-8 w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <svg class="w-10 h-10 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">Ecrew Absensi</h1>
                <p class="text-white/80 text-sm">Transwisata Prima Aviation</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Email</label>
                    <input type="email" id="loginEmail" required 
                           class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50"
                           placeholder="Masukkan email Anda">
                </div>
                
                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Password</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50"
                           placeholder="Masukkan password">
                </div>
                
                <div>
                    <label class="block text-white/90 text-sm font-medium mb-2">Login Sebagai</label>
                    <select id="userRole" class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-white/50">
                        <option value="user" class="text-gray-800">User</option>
                        <option value="admin" class="text-gray-800">Admin</option>
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-white text-indigo-600 py-3 rounded-lg font-semibold hover:bg-gray-100 transition duration-300 shadow-lg">
                    Masuk
                </button>
            </form>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="userDashboard" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900">Ecrew Absensi</h1>
                            <p class="text-sm text-gray-500">Transwisata Prima Aviation</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600" id="currentDateTime"></span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800 font-medium">Keluar</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="showTab('dashboard')" class="nav-tab active py-4 px-2 border-b-2 border-indigo-500 text-indigo-600 font-medium">
                        Dashboard
                    </button>
                    <button onclick="showTab('attendance')" class="nav-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                        Absensi
                    </button>
                    <button onclick="showTab('history')" class="nav-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                        Riwayat
                    </button>
                </div>
            </div>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Status Card -->
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-6 text-white mb-8 shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold mb-2">Selamat Datang!</h2>
                        <p class="text-indigo-100" id="welcomeMessage">Semoga hari Anda menyenangkan</p>
                    </div>
                    <div class="text-right">
                        <div class="status-badge bg-white/20 px-4 py-2 rounded-full">
                            <span id="attendanceStatus">Belum Absen</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-xl p-6 shadow-sm border">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Aksi Cepat</h3>
                    <div class="space-y-3">
                        <button onclick="showTab('attendance')" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition duration-300">
                            Absen Sekarang
                        </button>
                        <button onclick="showTab('history')" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition duration-300">
                            Lihat Riwayat
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-sm border">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Statistik Hari Ini</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Jam Masuk:</span>
                            <span class="font-medium" id="todayClockIn">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Jam Pulang:</span>
                            <span class="font-medium" id="todayClockOut">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Kerja:</span>
                            <span class="font-medium" id="todayWorkTime">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- News Section -->
            <div class="bg-white rounded-xl p-6 shadow-sm border">
                <h3 class="text-lg font-semibold text-gray-900 mb-6">Berita Terkini</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="newsContainer">
                    <!-- News items will be populated here -->
                </div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendanceTab" class="tab-content hidden max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Absensi</h2>
                
                <!-- Attendance Form -->
                <form id="attendanceForm" class="space-y-6">
                    <!-- Personal Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                            <input type="text" id="employeeName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="employeeEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Divisi</label>
                            <select id="division" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Pilih Divisi</option>
                                <option value="Operations">Operations</option>
                                <option value="Ground Handling">Ground Handling</option>
                                <option value="Customer Service">Customer Service</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Administration">Administration</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Posisi</label>
                            <input type="text" id="position" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bertugas Sebagai</label>
                            <input type="text" id="dutyAs" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Pekerjaan</label>
                            <select id="workType" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Pilih Jenis Pekerjaan</option>
                                <option value="Office Work">Office Work</option>
                                <option value="Field Work">Field Work</option>
                                <option value="Remote Work">Remote Work</option>
                                <option value="Travel Assignment">Travel Assignment</option>
                            </select>
                        </div>
                    </div>

                    <!-- Photo Capture -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Foto Absensi</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <div id="cameraContainer" class="hidden">
                                <video id="camera" class="w-full max-w-md mx-auto rounded-lg mb-4" autoplay></video>
                                <button type="button" onclick="capturePhoto()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                                    Ambil Foto
                                </button>
                            </div>
                            <div id="photoPreview" class="hidden">
                                <img id="capturedPhoto" class="w-full max-w-md mx-auto rounded-lg mb-4">
                                <button type="button" onclick="retakePhoto()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">
                                    Ambil Ulang
                                </button>
                            </div>
                            <div id="cameraButton">
                                <button type="button" onclick="startCamera()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700">
                                    Buka Kamera
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Location -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi Absensi</label>
                        <div class="space-y-4">
                            <button type="button" onclick="getCurrentLocation()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
                                </svg>
                                Dapatkan Lokasi Saat Ini
                            </button>
                            <div id="mapContainer" class="map-container hidden"></div>
                            <div id="locationInfo" class="hidden p-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600 mb-2">Koordinat: <span id="coordinates"></span></p>
                                <div id="radiusStatus" class="p-3 rounded-lg font-medium"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Reason for being outside radius (shown conditionally) -->
                    <div id="outsideRadiusReason" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Alasan Berada di Luar Radius Kantor</label>
                        <textarea id="outsideReason" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Jelaskan alasan Anda berada di luar radius kantor..."></textarea>
                    </div>

                    <!-- Late reason (shown conditionally) -->
                    <div id="lateReasonSection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Alasan Terlambat</label>
                        <textarea id="lateReason" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Jelaskan alasan keterlambatan Anda..."></textarea>
                    </div>

                    <!-- Work remark (shown for clock out) -->
                    <div id="workRemarkSection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Remark Pekerjaan Hari Ini</label>
                        <textarea id="workRemark" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Jelaskan pekerjaan yang telah Anda lakukan hari ini..."></textarea>
                    </div>

                    <!-- Work photo (shown for clock out) -->
                    <div id="workPhotoSection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Foto Pekerjaan Hari Ini</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="workPhoto" accept="image/*" class="hidden" onchange="previewWorkPhoto(event)">
                            <div id="workPhotoPreview" class="hidden">
                                <img id="workPhotoImg" class="w-full max-w-md mx-auto rounded-lg mb-4">
                                <button type="button" onclick="document.getElementById('workPhoto').click()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">
                                    Ganti Foto
                                </button>
                            </div>
                            <div id="workPhotoButton">
                                <button type="button" onclick="document.getElementById('workPhoto').click()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700">
                                    Pilih Foto dari Gallery
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex space-x-4">
                        <button type="submit" id="clockInBtn" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300">
                            Clock In
                        </button>
                        <button type="button" id="clockOutBtn" onclick="clockOut()" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition duration-300 hidden">
                            Clock Out
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="tab-content hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Riwayat Absensi</h2>
                
                <!-- Filter -->
                <div class="mb-6 flex flex-wrap gap-4">
                    <input type="date" id="filterDate" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <select id="filterMonth" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">Semua Bulan</option>
                        <option value="01">Januari</option>
                        <option value="02">Februari</option>
                        <option value="03">Maret</option>
                        <option value="04">April</option>
                        <option value="05">Mei</option>
                        <option value="06">Juni</option>
                        <option value="07">Juli</option>
                        <option value="08">Agustus</option>
                        <option value="09">September</option>
                        <option value="10">Oktober</option>
                        <option value="11">November</option>
                        <option value="12">Desember</option>
                    </select>
                    <button onclick="filterHistory()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                        Filter
                    </button>
                </div>

                <!-- History Table -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Tanggal</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Clock In</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Clock Out</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Total Kerja</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Overtime</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="divide-y divide-gray-200">
                            <!-- History data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen bg-gray-50">
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-red-600 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900">Admin Dashboard</h1>
                            <p class="text-sm text-gray-500">Transwisata Prima Aviation</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="text-red-600 hover:text-red-800 font-medium">Keluar</button>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl p-6 shadow-sm border">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Total Karyawan</h3>
                    <p class="text-3xl font-bold text-indigo-600" id="totalEmployees">0</p>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm border">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Hadir Hari Ini</h3>
                    <p class="text-3xl font-bold text-green-600" id="presentToday">0</p>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-sm border">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Terlambat</h3>
                    <p class="text-3xl font-bold text-red-600" id="lateToday">0</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Data Absensi Real-time</h2>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Nama</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Divisi</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Clock In</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Clock Out</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-900">Lokasi</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody" class="divide-y divide-gray-200">
                            <!-- Admin data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentLocation = null;
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
        let currentAttendance = null;
        let map = null;
        let camera = null;
        
        // Office coordinates for radius checking
        const officeCoords = [
            { lat: -6.267716, lng: 106.897317 },
            { lat: -6.265146, lng: 106.885701 }
        ];
        const radiusMeters = 250;

        // Sample news data
        const newsData = [
            {
                title: "Peningkatan Protokol Keselamatan",
                content: "Mulai minggu depan, akan ada protokol keselamatan baru untuk semua karyawan ground handling.",
                date: "2024-01-15",
                category: "Keselamatan"
            },
            {
                title: "Training Program Baru",
                content: "Program pelatihan customer service akan dimulai bulan depan. Pendaftaran dibuka hingga akhir bulan.",
                date: "2024-01-14",
                category: "Training"
            },
            {
                title: "Update Sistem Absensi",
                content: "Sistem absensi telah diperbarui dengan fitur foto dan lokasi untuk meningkatkan akurasi.",
                date: "2024-01-13",
                category: "Sistem"
            }
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            loadNews();
            checkTodayAttendance();
        });

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const role = document.getElementById('userRole').value;
            
            // Simple validation (in real app, this would be server-side)
            if (email && password) {
                currentUser = {
                    email: email,
                    role: role,
                    name: email.split('@')[0]
                };
                
                document.getElementById('loginScreen').classList.add('hidden');
                
                if (role === 'admin') {
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    loadAdminData();
                } else {
                    document.getElementById('userDashboard').classList.remove('hidden');
                    document.getElementById('welcomeMessage').textContent = `Selamat datang, ${currentUser.name}!`;
                }
            }
        });

        // Logout functionality
        function logout() {
            currentUser = null;
            currentLocation = null;
            if (camera) {
                camera.getTracks().forEach(track => track.stop());
                camera = null;
            }
            
            document.getElementById('userDashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Reset form
            document.getElementById('loginForm').reset();
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active', 'border-indigo-500', 'text-indigo-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Add active class to selected nav tab
            event.target.classList.add('active', 'border-indigo-500', 'text-indigo-600');
            event.target.classList.remove('border-transparent', 'text-gray-500');
            
            // Special handling for attendance tab
            if (tabName === 'attendance') {
                checkAttendanceStatus();
            }
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('id-ID', options);
        }

        // Load news
        function loadNews() {
            const container = document.getElementById('newsContainer');
            container.innerHTML = '';
            
            newsData.forEach(news => {
                const newsCard = document.createElement('div');
                newsCard.className = 'news-card bg-gray-50 rounded-lg p-4 hover:shadow-md transition-all duration-300';
                newsCard.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-medium text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full">${news.category}</span>
                        <span class="text-xs text-gray-500">${new Date(news.date).toLocaleDateString('id-ID')}</span>
                    </div>
                    <h4 class="font-semibold text-gray-900 mb-2">${news.title}</h4>
                    <p class="text-sm text-gray-600">${news.content}</p>
                `;
                container.appendChild(newsCard);
            });
        }

        // Camera functionality
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' } 
                });
                camera = stream;
                
                const video = document.getElementById('camera');
                video.srcObject = stream;
                
                document.getElementById('cameraButton').classList.add('hidden');
                document.getElementById('cameraContainer').classList.remove('hidden');
            } catch (error) {
                alert('Tidak dapat mengakses kamera. Pastikan Anda memberikan izin kamera.');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('camera');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            const photoData = canvas.toDataURL('image/jpeg');
            document.getElementById('capturedPhoto').src = photoData;
            
            document.getElementById('cameraContainer').classList.add('hidden');
            document.getElementById('photoPreview').classList.remove('hidden');
            
            // Stop camera
            if (camera) {
                camera.getTracks().forEach(track => track.stop());
            }
        }

        function retakePhoto() {
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('cameraButton').classList.remove('hidden');
        }

        // Location functionality
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        displayLocation();
                        checkRadius();
                    },
                    function(error) {
                        alert('Tidak dapat mendapatkan lokasi. Pastikan GPS aktif dan berikan izin lokasi.');
                    }
                );
            } else {
                alert('Geolocation tidak didukung oleh browser ini.');
            }
        }

        function displayLocation() {
            if (!currentLocation) return;
            
            document.getElementById('coordinates').textContent = 
                `${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}`;
            
            // Initialize map
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.classList.remove('hidden');
            
            if (map) {
                map.remove();
            }
            
            map = L.map('mapContainer').setView([currentLocation.lat, currentLocation.lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add current location marker
            L.marker([currentLocation.lat, currentLocation.lng])
                .addTo(map)
                .bindPopup('Lokasi Anda')
                .openPopup();
            
            // Add office markers
            officeCoords.forEach((coord, index) => {
                L.marker([coord.lat, coord.lng])
                    .addTo(map)
                    .bindPopup(`Kantor ${index + 1}`);
                
                // Add radius circle
                L.circle([coord.lat, coord.lng], {
                    color: 'blue',
                    fillColor: '#30f',
                    fillOpacity: 0.1,
                    radius: radiusMeters
                }).addTo(map);
            });
            
            document.getElementById('locationInfo').classList.remove('hidden');
        }

        function checkRadius() {
            if (!currentLocation) return;
            
            let withinRadius = false;
            
            for (let coord of officeCoords) {
                const distance = calculateDistance(
                    currentLocation.lat, currentLocation.lng,
                    coord.lat, coord.lng
                );
                
                if (distance <= radiusMeters) {
                    withinRadius = true;
                    break;
                }
            }
            
            const statusDiv = document.getElementById('radiusStatus');
            const reasonSection = document.getElementById('outsideRadiusReason');
            
            if (withinRadius) {
                statusDiv.className = 'p-3 rounded-lg font-medium bg-green-100 text-green-800';
                statusDiv.textContent = 'Anda berada dalam radius kantor';
                reasonSection.classList.add('hidden');
                document.getElementById('outsideReason').required = false;
            } else {
                statusDiv.className = 'p-3 rounded-lg font-medium bg-red-100 text-red-800';
                statusDiv.textContent = 'Anda berada di luar radius kantor';
                reasonSection.classList.remove('hidden');
                document.getElementById('outsideReason').required = true;
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Attendance form handling
        document.getElementById('attendanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            clockIn();
        });

        function checkAttendanceStatus() {
            const today = new Date().toDateString();
            currentAttendance = attendanceData.find(record => 
                record.email === currentUser.email && 
                new Date(record.date).toDateString() === today
            );
            
            if (currentAttendance && currentAttendance.clockIn) {
                // Already clocked in
                document.getElementById('clockInBtn').classList.add('hidden');
                document.getElementById('clockOutBtn').classList.remove('hidden');
                
                // Show work remark and photo sections
                document.getElementById('workRemarkSection').classList.remove('hidden');
                document.getElementById('workPhotoSection').classList.remove('hidden');
                
                // Populate form with existing data
                populateFormWithExistingData();
            } else {
                // Not clocked in yet
                document.getElementById('clockInBtn').classList.remove('hidden');
                document.getElementById('clockOutBtn').classList.add('hidden');
                document.getElementById('workRemarkSection').classList.add('hidden');
                document.getElementById('workPhotoSection').classList.add('hidden');
            }
        }

        function populateFormWithExistingData() {
            if (!currentAttendance) return;
            
            document.getElementById('employeeName').value = currentAttendance.name || '';
            document.getElementById('employeeEmail').value = currentAttendance.email || '';
            document.getElementById('division').value = currentAttendance.division || '';
            document.getElementById('position').value = currentAttendance.position || '';
            document.getElementById('dutyAs').value = currentAttendance.dutyAs || '';
            document.getElementById('workType').value = currentAttendance.workType || '';
        }

        function clockIn() {
            const now = new Date();
            const timeString = now.toTimeString().split(' ')[0];
            const hour = now.getHours();
            
            // Check if late
            let status = "Terima Kasih Anda Telah Absen Tepat Waktu";
            let isLate = false;
            
            if (hour >= 9 && now.getMinutes() > 0) {
                status = "Anda Terlambat Absen";
                isLate = true;
                document.getElementById('lateReasonSection').classList.remove('hidden');
                document.getElementById('lateReason').required = true;
            }
            
            // Validate required fields
            if (!validateAttendanceForm()) return;
            
            const attendanceRecord = {
                id: Date.now(),
                date: now.toISOString(),
                name: document.getElementById('employeeName').value,
                email: document.getElementById('employeeEmail').value,
                division: document.getElementById('division').value,
                position: document.getElementById('position').value,
                dutyAs: document.getElementById('dutyAs').value,
                workType: document.getElementById('workType').value,
                clockIn: timeString,
                clockInStatus: status,
                lateReason: isLate ? document.getElementById('lateReason').value : '',
                location: currentLocation,
                photo: document.getElementById('capturedPhoto').src,
                outsideReason: document.getElementById('outsideReason').value || '',
                attendanceStatus: 'on working'
            };
            
            // Update or add record
            const existingIndex = attendanceData.findIndex(record => 
                record.email === currentUser.email && 
                new Date(record.date).toDateString() === now.toDateString()
            );
            
            if (existingIndex >= 0) {
                attendanceData[existingIndex] = { ...attendanceData[existingIndex], ...attendanceRecord };
            } else {
                attendanceData.push(attendanceRecord);
            }
            
            currentAttendance = attendanceRecord;
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            alert('Clock In berhasil! ' + status);
            checkAttendanceStatus();
            updateDashboardStats();
        }

        function clockOut() {
            if (!currentAttendance) {
                alert('Anda belum melakukan Clock In hari ini.');
                return;
            }
            
            const now = new Date();
            const timeString = now.toTimeString().split(' ')[0];
            const hour = now.getHours();
            const minute = now.getMinutes();
            
            // Determine clock out status
            let clockOutStatus = "";
            let overtime = 0;
            
            if (hour < 17) {
                clockOutStatus = "Anda Pulang Sebelum Waktunya";
            } else if (hour === 17 && minute <= 30) {
                clockOutStatus = "Anda Pulang Tepat Waktu";
            } else {
                clockOutStatus = "Waktu Kerja Melebihi";
                // Calculate overtime (after 17:31)
                const overtimeStart = new Date(now);
                overtimeStart.setHours(17, 31, 0, 0);
                overtime = Math.max(0, (now - overtimeStart) / (1000 * 60 * 60)); // in hours
            }
            
            // Calculate total work time
            const clockInTime = new Date();
            const [inHour, inMinute, inSecond] = currentAttendance.clockIn.split(':');
            clockInTime.setHours(parseInt(inHour), parseInt(inMinute), parseInt(inSecond));
            
            const workTimeMs = now - clockInTime;
            const workHours = Math.floor(workTimeMs / (1000 * 60 * 60));
            const workMinutes = Math.floor((workTimeMs % (1000 * 60 * 60)) / (1000 * 60));
            const workSeconds = Math.floor((workTimeMs % (1000 * 60)) / 1000);
            const totalWorkTime = `${workHours}:${workMinutes.toString().padStart(2, '0')}:${workSeconds.toString().padStart(2, '0')}`;
            
            // Validate work remark and photo
            const workRemark = document.getElementById('workRemark').value;
            const workPhoto = document.getElementById('workPhoto').files[0];
            
            if (!workRemark.trim()) {
                alert('Harap isi remark pekerjaan hari ini.');
                return;
            }
            
            if (!workPhoto) {
                alert('Harap pilih foto pekerjaan hari ini.');
                return;
            }
            
            // Update attendance record
            currentAttendance.clockOut = timeString;
            currentAttendance.clockOutStatus = clockOutStatus;
            currentAttendance.totalWorkTime = totalWorkTime;
            currentAttendance.overtime = overtime > 0 ? overtime.toFixed(2) + ' jam' : '0';
            currentAttendance.workRemark = workRemark;
            currentAttendance.attendanceStatus = 'pulang';
            
            // Update in storage
            const index = attendanceData.findIndex(record => record.id === currentAttendance.id);
            if (index >= 0) {
                attendanceData[index] = currentAttendance;
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            }
            
            alert('Clock Out berhasil! ' + clockOutStatus);
            
            // Reset form and hide clock out button
            document.getElementById('clockOutBtn').classList.add('hidden');
            document.getElementById('attendanceForm').reset();
            updateDashboardStats();
        }

        function validateAttendanceForm() {
            const requiredFields = ['employeeName', 'employeeEmail', 'division', 'position', 'dutyAs', 'workType'];
            
            for (let field of requiredFields) {
                if (!document.getElementById(field).value.trim()) {
                    alert(`Harap isi ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
                    return false;
                }
            }
            
            if (!currentLocation) {
                alert('Harap dapatkan lokasi terlebih dahulu.');
                return false;
            }
            
            if (!document.getElementById('capturedPhoto').src) {
                alert('Harap ambil foto terlebih dahulu.');
                return false;
            }
            
            // Check if outside radius reason is required
            if (document.getElementById('outsideReason').required && !document.getElementById('outsideReason').value.trim()) {
                alert('Harap isi alasan berada di luar radius kantor.');
                return false;
            }
            
            // Check if late reason is required
            if (document.getElementById('lateReason').required && !document.getElementById('lateReason').value.trim()) {
                alert('Harap isi alasan terlambat.');
                return false;
            }
            
            return true;
        }

        function previewWorkPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('workPhotoImg').src = e.target.result;
                    document.getElementById('workPhotoButton').classList.add('hidden');
                    document.getElementById('workPhotoPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function checkTodayAttendance() {
            const today = new Date().toDateString();
            const todayRecord = attendanceData.find(record => 
                record.email === currentUser?.email && 
                new Date(record.date).toDateString() === today
            );
            
            if (todayRecord) {
                document.getElementById('todayClockIn').textContent = todayRecord.clockIn || '-';
                document.getElementById('todayClockOut').textContent = todayRecord.clockOut || '-';
                document.getElementById('todayWorkTime').textContent = todayRecord.totalWorkTime || '-';
                
                if (todayRecord.clockIn && !todayRecord.clockOut) {
                    document.getElementById('attendanceStatus').textContent = 'Sedang Bekerja';
                } else if (todayRecord.clockOut) {
                    document.getElementById('attendanceStatus').textContent = 'Selesai Bekerja';
                }
            }
        }

        function updateDashboardStats() {
            checkTodayAttendance();
            loadHistory();
        }

        // History functionality
        function loadHistory() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            const userRecords = attendanceData.filter(record => record.email === currentUser?.email);
            userRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            userRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${new Date(record.date).toLocaleDateString('id-ID')}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${record.clockIn || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${record.clockOut || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${record.totalWorkTime || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusColor(record.clockInStatus)}">
                            ${record.clockInStatus || 'Belum Absen'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">${record.overtime || '0'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusColor(status) {
            if (status?.includes('Tepat Waktu')) return 'bg-green-100 text-green-800';
            if (status?.includes('Terlambat')) return 'bg-red-100 text-red-800';
            return 'bg-gray-100 text-gray-800';
        }

        function filterHistory() {
            // Implementation for filtering history
            loadHistory();
        }

        // Admin functionality
        function loadAdminData() {
            updateAdminStats();
            loadAdminTable();
        }

        function updateAdminStats() {
            const today = new Date().toDateString();
            const todayRecords = attendanceData.filter(record => 
                new Date(record.date).toDateString() === today
            );
            
            document.getElementById('totalEmployees').textContent = new Set(attendanceData.map(r => r.email)).size;
            document.getElementById('presentToday').textContent = todayRecords.filter(r => r.clockIn).length;
            document.getElementById('lateToday').textContent = todayRecords.filter(r => r.clockInStatus?.includes('Terlambat')).length;
        }

        function loadAdminTable() {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = '';
            
            const today = new Date().toDateString();
            const todayRecords = attendanceData.filter(record => 
                new Date(record.date).toDateString() === today
            );
            
            todayRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${record.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${record.division}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${record.clockIn || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${record.clockOut || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusColor(record.clockInStatus)}">
                            ${record.attendanceStatus || 'Belum Absen'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">
                        ${record.location ? `${record.location.lat.toFixed(4)}, ${record.location.lng.toFixed(4)}` : '-'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97c365cfa1489c74',t:'MTc1NzM4NjQzMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
